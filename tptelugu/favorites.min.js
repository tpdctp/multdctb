let channels=[],epg={};async function initApp(){document.getElementById("spinner").style.display="block";try{channels=getFavoriteChannels(),await checkAndUpdateData(),populateFilters(),displayChannels()}catch(e){console.error("Initialization error:",e),document.getElementById("error").textContent="Failed to load data. Please try again later."}finally{document.getElementById("spinner").style.display="none"}}async function checkAndUpdateData(){try{const e=await fetch("https://db.jarviz.site/jarviz-tv/version.txt");if(!e.ok)throw new Error("Failed to fetch version");const t=await e.text();if(localStorage.getItem("cachedVersion")!==t){localStorage.clear();const e=await openDatabase();await fetchChannels(),await fetchEPG(e),localStorage.setItem("cachedVersion",t)}else{const e=await openDatabase();epg=await fetchEPGData(e)||{}}}catch(e){throw console.error("Failed to check and update data:",e),e}}async function fetchChannels(){try{if(!(await fetch("https://db.jarviz.site/jarviz-tv/channels.json")).ok)throw new Error("Failed to fetch channels");localStorage.setItem("cachedChannels",JSON.stringify(channels))}catch(e){throw console.error("Failed to fetch channels:",e),e}}async function fetchEPG(e){try{const t=await fetch("https://db.jarviz.site/jarviz-tv/epg.json");if(!t.ok)throw new Error("Failed to fetch EPG");epg=await t.json(),await storeEPGData(e,epg)}catch(e){throw console.error("Failed to fetch EPG:",e),e}}function getFavoriteChannels(){const e=getCookie("favorite");return e?JSON.parse(e):[]}function getCookie(e){const t=document.cookie.split(";");for(let n=0;n<t.length;n++){const a=t[n].trim();if(a.startsWith(e+"="))return decodeURIComponent(a.substring(e.length+1))}return null}function populateFilters(){const e=new Set,t=new Set;channels.forEach((n=>{n.genres&&n.genres.forEach((t=>e.add(t))),n.languages&&n.languages.forEach((e=>t.add(e)))})),populateSelect("genre",e),populateSelect("language",t)}function populateSelect(e,t){const n=document.getElementById(e);n.innerHTML='<option value="">All</option>',t.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,n.appendChild(t)}))}function displayChannels(){const e=document.getElementById("channels");e.innerHTML="";const t=document.createDocumentFragment(),n=document.getElementById("genre").value,a=document.getElementById("language").value,o=document.getElementById("search").value.toLowerCase();channels.filter((e=>(!n||e.genres&&e.genres.includes(n))&&(!a||e.languages&&e.languages.includes(a))&&e.name.toLowerCase().includes(o))).forEach((e=>{const n=createChannelElement(e);t.appendChild(n)})),e.appendChild(t)}function createChannelElement(e){const t=document.createElement("div");t.className="channel";const n=document.createElement("img");n.src=`https://tv.jarviz.site/assets/img/logo_512/ts${e.id}.webp`,n.alt=e.name,t.appendChild(n);const a=document.createElement("div"),o=document.createElement("h2");o.textContent=e.name,a.appendChild(o);const r=getNowPlaying(e.id),c=document.createElement("p");c.textContent=`Now Playing: ${r}`,a.appendChild(c);const l=document.createElement("button");if(l.textContent="Watch Live",l.addEventListener("click",(()=>{window.location.href=`live_player.html?id=${e.id}`})),a.appendChild(l),e.drm){const t=document.createElement("button");t.textContent="Watch Past Programs",t.addEventListener("click",(()=>{window.location.href=`channel_epg.html?id=${e.id}`})),a.appendChild(t)}return t.appendChild(a),t}function getNowPlaying(e){const t=new Date,n=epg[`ts${e}`];if(!n)return"Unknown";for(const e of n){const n=new Date(e.start.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2}).*/,"$1-$2-$3T$4:$5:$6Z")),a=new Date(e.stop.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2}).*/,"$1-$2-$3T$4:$5:$6Z"));if(t>=n&&t<a)return e.title}return"Unknown"}function filterChannels(){displayChannels()}function openDatabase(){return new Promise(((e,t)=>{const n=indexedDB.open("EPGDatabase",1);n.onerror=e=>t(e.target.error),n.onsuccess=t=>e(t.target.result),n.onupgradeneeded=e=>{e.target.result.createObjectStore("epg",{keyPath:"id"})}}))}function storeEPGData(e,t){return new Promise(((n,a)=>{const o=e.transaction("epg","readwrite");o.objectStore("epg").put({id:"epgData",data:t}),o.oncomplete=()=>n(),o.onerror=e=>a(e.target.error)}))}function fetchEPGData(e){return new Promise(((t,n)=>{const a=e.transaction("epg","readonly").objectStore("epg").get("epgData");a.onsuccess=e=>t(e.target.result?e.target.result.data:null),a.onerror=e=>n(e.target.error)}))}document.addEventListener("DOMContentLoaded",(()=>{initApp()})),document.getElementById("genre").addEventListener("change",filterChannels),document.getElementById("language").addEventListener("change",filterChannels),document.getElementById("search").addEventListener("input",filterChannels);
