let channels=[],epg={};async function initApp(){if(await checkIfUpdateNeeded())localStorage.setItem("previousPage",window.location.href),window.location.href="update.html";else{document.getElementById("spinner").style.display="block";try{channels=JSON.parse(localStorage.getItem("cachedChannels"))||[];const e=await openDatabase();epg=await fetchEPGData(e)||{},populateFilters(),displayChannels()}catch(e){console.error("Initialization error:",e),document.getElementById("error").style.display="block",document.getElementById("error").textContent="Failed to load data. Please try again later."}finally{document.getElementById("spinner").style.display="none"}}}async function checkIfUpdateNeeded(){try{const e=await fetch("https://db.jarviz.site/jarviz-tv/version.txt");if(!e.ok)throw new Error("Failed to fetch version");const t=await e.text();return localStorage.getItem("cachedVersion")!==t}catch(e){throw console.error("Failed to check version:",e),e}}function populateFilters(){const e=new Set,t=new Set;channels.forEach((n=>{n.genres&&n.genres.forEach((t=>e.add(t))),n.languages&&n.languages.forEach((e=>t.add(e)))})),populateSelect("genre",e),populateSelect("language",t)}function populateSelect(e,t){const n=document.getElementById(e);n.innerHTML='<option value="">All</option>',t.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,n.appendChild(t)}))}function displayChannels(){const e=document.getElementById("channels");e.innerHTML="";const t=document.createDocumentFragment(),n=document.getElementById("genre").value,a=document.getElementById("language").value,o=document.getElementById("search").value.toLowerCase();channels.filter((e=>(!n||e.genres&&e.genres.includes(n))&&(!a||e.languages&&e.languages.includes(a))&&e.name.toLowerCase().includes(o))).forEach(((e,n)=>{const a=createChannelElement(e);if(t.appendChild(a),(n+1)%4==0){const e=document.createElement("div");e.innerHTML='\n                <div class="channel">\n               \n                        \n                       \n                    </div>\n                </div>\n                ',t.appendChild(e)}})),e.appendChild(t)}function createChannelElement(e){const t=document.createElement("div");t.className="channel";const n=document.createElement("img");n.src=`assets/img/logo_402/ts${e.id}.webp`,n.setAttribute("alt",e.name),n.setAttribute("width","268px"),n.setAttribute("height","268px"),t.appendChild(n);const a=document.createElement("div"),o=document.createElement("h2");o.textContent=e.name,a.appendChild(o);const r=getNowPlaying(e.id),d=document.createElement("p");d.textContent=`Now Playing: ${r}`,a.appendChild(d);const l=document.createElement("button");if(l.textContent="Watch Live",l.addEventListener("click",(()=>{window.location.href=`/live_player.html?id=${e.id}`})),a.appendChild(l),e.drm){const t=document.createElement("button");t.textContent="Watch Past Programs",t.addEventListener("click",(()=>{window.location.href=`/channel_epg.html?id=${e.id}`})),a.appendChild(t)}return t.appendChild(a),t}function getNowPlaying(e){const t=new Date,n=epg[`ts${e}`];if(!n)return"Unknown";for(const e of n){const n=new Date(e.start.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2}).*/,"$1-$2-$3T$4:$5:$6Z")),a=new Date(e.stop.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2}).*/,"$1-$2-$3T$4:$5:$6Z"));if(t>=n&&t<a)return e.title}return"Unknown"}function filterChannels(){displayChannels()}function openDatabase(){return new Promise(((e,t)=>{const n=indexedDB.open("EPGDatabase",1);n.onerror=e=>t(e.target.error),n.onsuccess=t=>e(t.target.result),n.onupgradeneeded=e=>{e.target.result.createObjectStore("epg",{keyPath:"id"})}}))}async function fetchEPGData(e){return new Promise(((t,n)=>{const a=e.transaction("epg","readonly").objectStore("epg").get("epgData");a.onsuccess=e=>t(e.target.result?e.target.result.data:null),a.onerror=e=>n(e.target.error)}))}document.addEventListener("DOMContentLoaded",(()=>{initApp()})),document.getElementById("genre").addEventListener("change",filterChannels),document.getElementById("language").addEventListener("change",filterChannels),document.getElementById("search").addEventListener("input",filterChannels);
